const axios = require('axios');

class TelegramService {
  constructor() {
    this.botToken = process.env.TELEGRAM_BOT_TOKEN;
    this.apiUrl = `https://api.telegram.org/bot${this.botToken}`;
    console.log('ü§ñ Telegram Service Started with Actual Bot');
  }

  async sendMessage(chatId, message) {
    try {
      console.log(`üì§ Sending Telegram message to: ${chatId}`);
      
      const response = await axios.post(`${this.apiUrl}/sendMessage`, {
        chat_id: chatId,
        text: message,
        parse_mode: 'HTML'
      }, {
        timeout: 10000
      });
      
      console.log('‚úÖ Telegram message sent successfully');
      return response.data;
    } catch (error) {
      console.error('‚ùå Telegram message failed:');
      console.error('Error:', error.response?.data || error.message);
      
      // Specific error handling
      if (error.response?.data?.description?.includes('chat not found')) {
        throw new Error('Invalid Chat ID. Please start the bot first.');
      }
      if (error.response?.data?.description?.includes('bot was blocked')) {
        throw new Error('You have blocked the bot. Please unblock and try again.');
      }
      
      throw new Error(`Telegram API error: ${error.response?.data?.description || error.message}`);
    }
  }

  async sendWebsiteSummary(chatId, website, monitoringData) {
    const { statistics, currentStats } = monitoringData;
    
    const message = `
üåê <b>WEBSITE MONITORING SUMMARY</b>

<b>Website:</b> ${website.name}
<b>URL:</b> ${website.url}
<b>Status:</b> ${website.status === 'up' ? 'üü¢ UP' : 'üî¥ DOWN'}

<b>üìä PERFORMANCE METRICS</b>
‚Ä¢ Uptime: ${statistics.uptimePercentage}%
‚Ä¢ Response Time: ${currentStats.avgResponseTime}ms
‚Ä¢ Performance Score: ${currentStats.performanceScore}/100
‚Ä¢ SEO Score: ${currentStats.seoScore}/100

<b>üìà MONITORING STATS</b>
‚Ä¢ Total Checks: ${statistics.totalChecks}
‚Ä¢ Successful: ${statistics.upChecks}
‚Ä¢ Failed: ${statistics.downChecks}
‚Ä¢ Last Check: ${website.lastChecked ? new Date(website.lastChecked).toLocaleString() : 'Never'}

${website.status === 'down' ? 'üö® <b>ALERT: Website is currently DOWN!</b>' : '‚úÖ All systems operational!'}

<i>Generated by AI Website Monitor</i>
    `.trim();

    return await this.sendMessage(chatId, message);
  }
}

module.exports = new TelegramService();